---
title: "TG2 - wrangling e análise exp"
author: "Arthur Giestas"
date: "23/11/2021"
output: word_document
---

```{r bibliotecas, warning=FALSE}
library(dplyr)
library(tidyr)
library(stringr)
library(tidytext)
library(data.table)
library(wordcloud)
library(tm)
library(SnowballC)
library(Rcpp)
```

```{r exportação ds}
order_reviews_full <- read.csv("olist_order_reviews_dataset.csv", encoding = "UTF-8")
```

```{r wrangling}
#remove linhas sem comentários E sem título, remove colunas desnecessárias, acrescenta coluna com título concatenado ao texto do comentário
order_reviews <- order_reviews_full[!((order_reviews_full$review_comment_message == "") &
                                        (order_reviews_full$review_comment_title == "")),] %>%
  subset(data = order_reviews, select = c(-order_id,
                    -review_creation_date,
                    -review_answer_timestamp,
                    -review_id)) %>%
  mutate(comp_comment = str_c(review_comment_title, " ", review_comment_message))
```

```{r limpeza de palavras}
wc_db_clean <- order_reviews[,c(1, 4)]

wc_db_clean[,2] <- str_replace_all(wc_db_clean[,2], "[[:punct:]]", " ")

wc_db_clean[,2] <- gsub('[0-9]+', '', wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" nao ", " não ", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("exelente", "excelente", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("otima", "ótima", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("otimo", "ótimo", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("ótima", "ótimo", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("rápida", "rápido", wc_db_clean[,2])

# Limpeza nuvem BOM
wc_db_clean[,2] <- gsub("produtos", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("Produto", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" produto", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("produto ", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" prazos", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" prazo", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" loja ", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" entregue ", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" tudo", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("tudo", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("Tudo", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" comprar", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" compra", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("veio", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("dentro", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("chegou", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("entrega ", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("recebi ", "", wc_db_clean[,2])

# Limpeza nuvem NÃO BOM
wc_db_clean[,2] <- gsub("lannister", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub("comprei", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" dia ", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" dois", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" pois", "", wc_db_clean[,2])
wc_db_clean[,2] <- gsub(" pra ", "", wc_db_clean[,2])
```


```{r criação index 70/30}
index <- sample(1:nrow(wc_db_clean),
       0.7*nrow(wc_db_clean))
```


```{r wordcloud BOM}
wc_db_train <- wc_db_clean[index,] %>%
  filter(review_score > 3)

corpus_wc_bom <- Corpus(VectorSource(wc_db_train[,2])) %>%
  tm_map(removeWords, stopwords("portuguese")) %>%
  tm_map(removePunctuation) %>%
  tm_map(removeNumbers) %>%
  tm_map(content_transformer(tolower))

tdm <- TermDocumentMatrix(corpus_wc_bom)
m <- as.matrix(tdm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)

set.seed(1234)
wordcloud(words = d$word, freq = d$freq, min.freq = 1,
          max.words=20, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r dummy variables BOM}
df <- order_reviews_full[!((order_reviews_full$review_comment_message == "") & 
                             (order_reviews_full$review_comment_title == "")),] %>%
  mutate(comp_comment = str_c(review_comment_title, " ", review_comment_message))%>%
  select("review_score", "review_comment_message") %>%
  mutate(index = row_number())

df$index <- seq.int(nrow(df))

str(df$review_comment_message)


for (i in 1:1200) {
  
  #CRIACAO DA VARIAVEL RESPOSTA (Y)
  df$Y5[i] <- if_else(df$review_score[i] == 5, 1, 0)
  df$Y4[i] <- if_else(df$review_score[i] == 4, 1, 0)
  df$Y3[i] <- if_else(df$review_score[i] == 3, 0, 0)
  df$Y2[i] <- if_else(df$review_score[i] == 2, 0, 0)
  df$Y1[i] <- if_else(df$review_score[i] == 1, 0, 0)
  
  df$Y[i] <- df$Y5[i] + df$Y4[i] + df$Y3[i] + df$Y2[i] + df$Y1[i]
  
  #CRIACAO DAS VARIAVEIS DEUMMIES
  df$X_recomendo[i] <- ifelse(str_detect(df$review_comment_message[i], "recomendo"), 1, 0)
  df$X_antes[i] <- ifelse(str_detect(df$review_comment_message[i], "antes"), 1, 0)
  df$X_otimo[i] <- ifelse(str_detect(df$review_comment_message[i], "ótimo"), 1, 0)
  df$X_chegou[i] <- ifelse(str_detect(df$review_comment_message[i], "chegou"), 1, 0)
  df$X_adorei[i] <- ifelse(str_detect(df$review_comment_message[i], "adorei"), 1, 0)
  df$X_super[i] <- ifelse(str_detect(df$review_comment_message[i], "super"), 1, 0)
  df$X_qualidade[i] <- ifelse(str_detect(df$review_comment_message[i], "qualidade"), 1, 0)
  df$X_perfeito[i] <- ifelse(str_detect(df$review_comment_message[i], "perfeito"), 1, 0)
  df$X_prazo[i] <- ifelse(str_detect(df$review_comment_message[i], "certo"), 1, 0)
  df$X_excelente[i] <- ifelse(str_detect(df$review_comment_message[i], "excelente"), 1, 0)
  df$X_recebi[i] <- ifelse(str_detect(df$review_comment_message[i], "recebi"), 1, 0)
  df$X_rapido[i] <- ifelse(str_detect(df$review_comment_message[i], "rápido"), 1, 0)
  df$X_gostei[i] <- ifelse(str_detect(df$review_comment_message[i], "gostei"), 1, 0)
  df$X_entrega[i] <- ifelse(str_detect(df$review_comment_message[i], "entrega"), 1, 0)
  df$X_bom[i] <- ifelse(str_detect(df$review_comment_message[i], "bom"), 1, 0)
  df$X_bem[i] <- ifelse(str_detect(df$review_comment_message[i], "bem"), 1, 0)
  df$X_boa[i] <- ifelse(str_detect(df$review_comment_message[i], "boa"), 1, 0)
  df$X_muito[i] <- ifelse(str_detect(df$review_comment_message[i], "muito"), 1, 0)
  df$X_sempre[i] <- ifelse(str_detect(df$review_comment_message[i], "sempre"), 1, 0)
  df$X_parabens[i] <- ifelse(str_detect(df$review_comment_message[i], "parabéns"), 1, 0)

}
```

```{r wordcloud NAO BOM}
wc_db_train <- wc_db_clean[index,] %>%
  filter(review_score <= 3)

corpus_wc_nbom <- Corpus(VectorSource(wc_db_train[,2])) %>%
  tm_map(removeWords, stopwords("portuguese")) %>%
  tm_map(removePunctuation) %>%
  tm_map(removeNumbers) %>%
  tm_map(content_transformer(tolower))

tdm <- TermDocumentMatrix(corpus_wc_nbom)
m <- as.matrix(tdm)
v <- sort(rowSums(m),decreasing=TRUE)
d <- data.frame(word = names(v),freq=v)

set.seed(1234)
wordcloud(words = d$word, freq = d$freq, min.freq = 1,
          max.words=20, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r dummy variables NAO BOM}
db_test_nbom <- wc_db_clean[-index,]

str(db_test_nbom$review_comment_message)


for (i in 1:nrow(db_test_nbom)) {
  
  #CRIACAO DA VARIAVEL RESPOSTA (Y)
  db_test_nbom$Y5[i] <- if_else(db_test_nbom$review_score[i] == 5, 0, 0)
  db_test_nbom$Y4[i] <- if_else(db_test_nbom$review_score[i] == 4, 0, 0)
  db_test_nbom$Y3[i] <- if_else(db_test_nbom$review_score[i] == 3, 1, 0)
  db_test_nbom$Y2[i] <- if_else(db_test_nbom$review_score[i] == 2, 1, 0)
  db_test_nbom$Y1[i] <- if_else(db_test_nbom$review_score[i] == 1, 1, 0)
  
  db_test_nbom$Y[i] <- 
    db_test_nbom$Y5[i] +
    db_test_nbom$Y4[i] +
    db_test_nbom$Y3[i] +
    db_test_nbom$Y2[i] + 
    
    db_test_nbom$Y1[i]
  
  #CRIACAO DAS VARIAVEIS DEUMMIES
  db_test_nbom$X_recomendo[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "recomendo"), 1, 0)
  db_test_nbom$X_antes[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "porém"), 1, 0)
  db_test_nbom$X_otimo[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "aguardando"), 1, 0)
  db_test_nbom$X_chegou[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "quero"), 1, 0)
  db_test_nbom$X_adorei[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "apenas"), 1, 0)
  db_test_nbom$X_super[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "estou"), 1, 0)
  db_test_nbom$X_qualidade[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "comprei"), 1, 0)
  db_test_nbom$X_perfeito[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "bom"), 1, 0)
  db_test_nbom$X_prazo[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "ainda"), 1, 0)
  db_test_nbom$X_excelente[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "dias"), 1, 0)
  db_test_nbom$X_recebi[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "não"), 1, 0)
  db_test_nbom$X_rapido[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "outro"), 1, 0)
  db_test_nbom$X_gostei[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "contato"), 1, 0)
  db_test_nbom$X_entrega[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "pedido"), 1, 0)
  db_test_nbom$X_bom[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "site"), 1, 0)
  db_test_nbom$X_bem[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "nada"), 1, 0)
  db_test_nbom$X_boa[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "recebi"), 1, 0)
  db_test_nbom$X_muito[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "qualidade"), 1, 0)
  db_test_nbom$X_sempre[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "correios"), 1, 0)
  db_test_nbom$X_parabens[i] <-
    ifelse(str_detect(db_test_nbom$review_comment_message[i], "agora"), 1, 0)

}
```

```{r estimativa de pontuacao por palavra}
# cria função de moda
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

# Tokeniza num dataset de palavras, média, mediana, moda, var e dev pad.
# O dataset não possui observações com var = NA ou 0 ou <= 2.
# Ou seja, não possui palavras que apareçam apenas uma vez ou que apareçam
# tanto em comentários com notas altas como baixas, pois não contribuem
# para a determinação da nota.
word_evaluation <- wc_db_clean %>%
  unnest_tokens(output = "Palavras",
                input = comp_comment,
                token = "words") %>%
  group_by(Palavras) %>%
  summarise(avg_pt = mean(review_score), #"força" positiva ou negativa da palavra - fazer um diag. de dispersão kn-n, agrupar as palavras
            median_pt = median(review_score),
            mode_pt = as.double(getmode(review_score)),
            var_pt = var(review_score),
            dev_pt = sd(review_score)) %>%
  na.omit() %>%
  filter(var_pt < 2 & var_pt != 0) #revisar essa decisão de var <= 2 (foi arbitrário)

# pode-se criar um modelo no final que definiria a nota com base nas palavras
# nota entre 1 e 5 ou entre faixas (de 1 a 2, ou <2,5, >2,5, bom ou ruim) - transformar em classificação
# validaçao cruzada - não podemos fazer as nuvens/kn-n no mesmo conjunto que vamos rodar os testes
# quantas palavras são necessárias para definir uma nota? 
 
```


